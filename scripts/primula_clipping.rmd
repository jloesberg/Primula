---
title: "Primula Clipping Experiment"
author: "JL"
date: "2/13/2023"
output: html_document
---

To do:
- Figure out if flowernt (plants that flowered but were not in the experiment) plants made seeds and add to fruitset
anova(gmm,gmmDx1,test="Chisq")
- Make table of results for each vital rate (with LRT tests)

```{r}
#packages:
#read
library(tidyverse)
library(lubridate)
library(AICcmodavg)
library(lme4)
library(nlme)
library(car)
library(wesanderson) # for colors

theme_set(theme_classic()) #for ggplot
FF <- wes_palettes$FantasticFox1
Z <- wes_palettes$Zissou1
R <- wes_palettes$Royal2
I <- wes_palettes$IsleofDogs1
```

```{r}
#read in data, make df's
# Add in demography data:
source("../scripts/dode_allyears_cleaned.R")

#add in tags in clipping experiment
clip <- read.csv("../data/2021_Primula_Clipping.csv")
clip <- clip %>% 
  select(1:8, -c(coor, date.of.clipping)) %>% 
  mutate(tag = as.character(tag),
         plot = as.character(plot),
         initial.flower = no.flowers.at.start +no.buds.at.start)

#adding in soil moisture data
sm <- read.csv("C:/Users/Jenna/Dropbox/Williams' Lab/Students/Jenna/loggerdata/cleaned.data/SM_aprjun15avg_allyears.csv")
sm <- sm %>% mutate(plot = as.character(plot),
                    year = as.character(year))

#add in number of seeds made
seeds21 <- read.csv("C:/Users/Jenna/Dropbox/Williams' Lab/Cowichan IDE/Cowichan_DemographyData/Dodecatheon/2021_Dodecatheon_Seed_Counts.csv")

#In 2021, which flowers made it to being a capsule?
#seeds21 <- subset(seeds21, tag != "1556") # not an experiment plant
#seeds21 <- subset(seeds21, tag != 1998) # not an experiment plant
#seeds21 <- subset(seeds21, tag != 1813)
seeds21 <- seeds21 %>% 
  mutate(pseeds = if_else(no.seeds > 0, 1, 0),
         tag = as.character(tag),
         plot = as.character(plot))
seeds21$pseeds[is.na(seeds21$pseeds)] <- 1 #assuming the plants where we couldn't count capsules separately had all their capsules contribute to seed total


cap <- seeds21 %>% group_by(tag, plot) %>% 
  summarize(no.success.cap = sum(pseeds),
            total.seeds = sum(no.seeds))
cap$total.seeds[cap$tag == 1556] <- 29
cap$total.seeds[cap$tag == 1988] <- 58
cap$total.seeds[cap$tag == 1988] <- 58
cap$total.seeds[cap$tag == 282] <- 50
cap$total.seeds[cap$tag == 494] <-98



#adding cap to the clip df

clip <- full_join(clip, cap) %>% 
  mutate(total.seeds = if_else(no.success.cap == 0, 0, total.seeds))
remove(cap)
clip$no.success.cap[is.na(clip$no.success.cap)] <- 0
clip$initial.flower[clip$tag == 1490] <- 6
clip$initial.flower[clip$tag == 5769] <- 5
clip$initial.flower[clip$tag == 962] <- 6
clip$initial.flower[clip$tag == 5746] <- 5
clip$no.success.cap[clip$tag == 540] <- 4
clip$no.success.cap[clip$tag == 693] <- 2



############################################################################
#add in clipping experiment treatments

clip <-  left_join(clip, Dodecatheon, by = c("tag", "plot")) %>% 
  filter(year == 2021) %>% 
  mutate(fruitset = no.success.cap/initial.flower) %>% 
  mutate(pflower = as.factor(pflower),
         rgr = log.ros.areaT1-log.ros.area) #calc relative growth rate

# these are all of the tags in the clipping experiment for 2021 and 2022
#add soil moisture:
clip <- left_join(clip, sm)

#subsetting - get rid of 12 and 14 (only 3 observations per plot - maybe this will help?)
clip.sub <- clip %>% filter(plot != "12") %>% 
  filter(plot != "14")

###
# what sizes are plants in 2021 to 2022
Dodecatheon.21 <- Dodecatheon %>% 
  filter(year == "2021")
#of the plants that flowered in 2021, what was their min size? it doesnt look like I need to set a max size
ggplot(Dodecatheon.21, aes(log.ros.area, log.ros.areaT1, color = pflower)) +
  geom_jitter()+
  facet_wrap(~trt)
ggplot(subset(Dodecatheon.21, !is.na(pflower)), aes(log.ros.area))+
  geom_histogram()+
  facet_wrap(pflower~trt)
min <- Dodecatheon.21 %>% 
  group_by(pflower, trt) %>% 
  summarize(min.size = min(log.ros.area, na.rm = TRUE))
clip2 <- Dodecatheon.21 %>% 
  filter(log.ros.area > 2) %>% 
  mutate(pflower = as.factor(pflower))
join <-  left_join(clip2, clip)
join <- join %>% 
  #eft_join(join,sm, by = c("trt", "plot", "year")) %>% 
  mutate(treatment = if_else(is.na(treatment) & pflower == 0, "veg", if_else(is.na(treatment) & pflower == 1, "flowernt", treatment),  treatment),
         rgr = log.ros.areaT1-log.ros.area)

remove(sm, clip2, Dodecatheon, min, Dodecatheon.21)

#none experiment plants that flowered:
no.exp <- read.csv("/Users/Jenna/Dropbox/Williams' Lab/Cowichan IDE/Cowichan_DemographyData/Dodecatheon/2021_Dodecatheon_Resurveys.csv", header=T)
no.exp <- no.exp %>% 
  filter(!is.na(pseeds)) %>% 
  rename(fruitset1 = pseeds) %>% 
  select(c(plot, tag, fruitset1)) %>% 
  mutate(plot = as.character(plot),
         tag = as.character(tag))
#making a decision here that I may need to change: setting pseeds = frutiset (ie assuming that for these plants, if you made seeds, all of your flowers made seeds) - I have the data to check this, but will go check this later
join <- left_join(join, no.exp)
join <- join %>% 
  mutate( fruitset = coalesce(fruitset, fruitset1),
          total.seeds = if_else(fruitset == 0, 0, total.seeds),
          pseeds = if_else(total.seeds > 0, 1, 0),
          log.total.seeds = if_else(total.seeds > 0, log(total.seeds), NA)) %>% 
  select(-fruitset1) %>% 
  #filter out the two plots with very few observations
  filter(plot != "12") %>% 
  filter(plot != "14")
remove(no.exp)

#also add in number of seeds:
#test <- left_join(join, seeds21)

```

```{r}
################################################################################
# Plan B! 

# calculate relative growth rate - did plants that were clipped grow more or less than plants that weren't
clip %>% ggplot(aes(fruitset, rgr))+
  geom_boxplot()+
  facet_wrap(~treatment)

m1 <- lmer(rgr~trt+ (1|plot), data = clip, REML = F)
anova(m1)
summary(m1)
#drought plants grew more than control plants! and irrigated grew less than control plants? hmm that seems weird. But no effect of clipping treatment on growth 
#
# to make sure these are the same size: only include plants that were above ground in 2022
# 
fnull <- glmer(pflowerT1 ~ 1 + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
f1 <- glmer(pflowerT1 ~ rgr + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(fnull, f1, test="Chisq") #LTR test
#nope!

f2<- glmer(pflowerT1 ~ fruitset + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(fnull, f2, test="Chisq") #LTR test
#yep!

f3<- glmer(pflowerT1 ~ fruitset + rgr + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(f2, f3, test="Chisq") #LTR test
#nope adding rgr doesnt help

f4<- glmer(pflowerT1 ~ fruitset*rgr + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(f2, f4, test="Chisq") #LTR test
#nope

f5<- glmer(pflowerT1 ~ trt + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial") #singular fit!
anova(fnull, f5, test="Chisq") #LTR test



```

```{r}
#not using size in model - this may be weird..
#GROWTH

ggplot(clip.sub, aes(x = trt, y = log.ros.areaT1))+
  geom_boxplot()
ggplot(clip.sub, aes(x = plot, y = log.ros.areaT1, color = trt))+
  geom_boxplot()
ggplot(clip.sub, aes(x = treatment, y = log.ros.areaT1))+
  geom_boxplot()+
  facet_wrap(~trt)

#with random effects
gnull<- lmer(log.ros.areaT1 ~ trt +(1|plot), data = clip.sub, REML = F)
gnull1<- lmer(log.ros.areaT1 ~ treatment + (1|plot), data = clip.sub, REML= F)
gnull2<- lmer(log.ros.areaT1 ~ treatment + trt + (1|plot), data = clip.sub, REML= F)
anova(gnull, gnull2, test="Chisq") #this is LRT?
summary(gnull2)

```

```{r}

#with random effects
gnull<- lmer(log.ros.areaT1 ~ trt +(1|plot), data = clip.sub, REML = F)
gnull1<- lmer(log.ros.areaT1 ~  fruitset*trt + (1|plot), data = clip.sub, REML= F)
anova(gnull, gnull1, test="Chisq") #this is LRT?
summary(gnull1)

fnull<- lmer(pflowerT1 ~ (1|plot), data = clip.sub, REML = F)
fnull1<- lmer(pflowerT1 ~ fruitset + (1|plot), data = clip.sub, REML= F)
fnull2<- lmer(pflowerT1 ~ treatment + trt + (1|plot), data = clip.sub, REML= F)
anova(fnull, fnull1, test="Chisq") #this is LRT?
summary(gnull2)
```


Maybe cost is in whether or not you flower, not how much effort you put into flowering?

Growth::
```{r}
#######################################################################################


###
ggplot(join, aes(x = log.ros.area, y = log.ros.areaT1))+
  geom_jitter()+
  geom_smooth(method = "lm", se = F)+
  facet_wrap(~treatment)
ggplot(join, aes(x = log.ros.area, y = log.ros.areaT1))+
  geom_jitter()+
  geom_smooth(method = "lm", se = F)+
  facet_wrap(~trt)

gnull.base <- lmer(log.ros.areaT1 ~ 1 + (1|plot), data = join, REML = F)
gnull<- lmer(log.ros.areaT1 ~ log.ros.area + (1|plot), data = join, REML = F)
growth <- anova(gnull.base, gnull, test="Chisq") #this is LRT

growth #including size improves the model:
summary(test)


gnull1<- lmer(log.ros.areaT1 ~ log.ros.area + treatment + (1|plot), data = join, REML = F)
growth2 <- anova(gnull, gnull1, test="Chisq") #this is LRT
growth2
#no cost on growth

gnull2<- lmer(log.ros.areaT1 ~ log.ros.area + trt + (1|plot), data = join, REML = F)
anova(gnull, gnull2, test="Chisq") #this is LRT
#nope!

gnull1<- lmer(log.ros.areaT1 ~ log.ros.area+ treatment + (1|plot), data = join, REML= F)
gnull2<- lmer(log.ros.areaT1 ~ log.ros.area+ treatment + trt + (1|plot), data = join, REML= F)
anova(gnull, gnull2, test="Chisq") #this is LRT?
summary(gnull)

#pflower:
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter()+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~treatment)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .01)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~trt)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .01)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(treatment~trt)

fnull <- glmer(pflowerT1 ~ log.ros.area + (1|plot), data = join, family = "binomial")
f1 <- glmer(pflowerT1 ~ log.ros.area + trt + (1|plot), data = join, family = "binomial")
anova(fnull, f1, test="Chisq") #LTR test
#nope

f2<- glmer(pflowerT1 ~ log.ros.area+treatment + (1|plot), data = join, family = "binomial")
anova(fnull, f2, test="Chisq") #LTR test
#yes, significant! But seems like it is mostly for veg vs the rest

f3<- glmer(pflowerT1 ~ log.ros.area + treatment*trt + (1|plot), data = join, family = "binomial")
anova(f2, f3, test="Chisq") #LTR test

summary(f2)

```

```{r}
#Survival
s<- glmer(as.factor(psurvivalT1) ~ 1 + (1|plot), data = join, family = "binomial")
snull <- glmer(as.factor(psurvivalT1) ~ log.ros.area + (1|plot), data = join, family = "binomial")
anova(s, snull,test="Chisq") #LTR test

snull1 <- glmer(as.factor(psurvivalT1) ~ log.ros.area + treatment + (1|plot), data = join, family = "binomial")
anova(snull, snull1,test="Chisq") #LTR test

snull2 <- glmer(as.factor(psurvivalT1) ~ log.ros.area + trt + (1|plot), data = join, family = "binomial")
anova(snull, snull2,test="Chisq") #LTR test
```

#What to do about differential flowering success → what about 3 models

```{r}
#Probability of flowering model…
fbase <- glmer(pflowerT1 ~ 1 + (1|plot), data = join, family = "binomial")
fnull <- glmer(pflowerT1 ~ log.ros.area + (1|plot), data = join, family = "binomial")
anova(fbase, fnull, test="Chisq") #LTR test

f1 <- glmer(pflowerT1 ~ log.ros.area + treatment + (1|plot), data = join, family = "binomial")
anova(fnull, f1, test="Chisq") #LTR test

f2 <- glmer(pflowerT1 ~ log.ros.area + trt + (1|plot), data = join, family = "binomial")
anova(fnull, f2, test="Chisq") #LTR test
#great, this one is sig

f3 <- glmer(pflowerT1 ~ log.ros.area*trt + (1|plot), data = join, family = "binomial")
anova(f2, f3, test="Chisq") #LTR test

summary(f2)

```
```{r}
## make graph for that model:
# pflower av plots
pred.control<-  expand.grid(log.ros.area = seq(1, 5.25, by = .1), trt = "control")#this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip, and control plots! seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.control2 <- predict(f2, newdata = pred.control, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
control.pflower <- as.data.frame(pred.control2)
pred.control <- cbind(pred.control, control.pflower)
#
pred.irrigated<-  expand.grid(log.ros.area = seq(1, 5.25, by = .1), trt = "irrigated")#this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip, and irrigated plots! seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.irrigated2 <- predict(f2, newdata = pred.irrigated, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
irrigated.pflower <- as.data.frame(pred.irrigated2)
pred.irrigated <- cbind(pred.irrigated, irrigated.pflower)
#
pred.drought<-  expand.grid(log.ros.area = seq(1, 5.25, by = .1), trt = "drought")#this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip, and drought plots! seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.drought2 <- predict(f2, newdata = pred.drought, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
drought.pflower <- as.data.frame(pred.drought2)
pred.drought <- cbind(pred.drought, drought.pflower)

ggplot(join, aes(x=log.ros.area, y=pflowerT1))+
  geom_jitter(height = 0.025, size = 1, alpha= 0.5) +
  geom_line(data = pred.drought, aes(x = log.ros.area, y = pred.drought2), color = Z[5], linewidth = 1) +
  geom_line(data = pred.irrigated, aes(x = log.ros.area, y = pred.irrigated2), color = Z[1], linewidth = 1) + 
  geom_line(data = pred.control, aes(x = log.ros.area, y = pred.control2), color = Z[3], linewidth = 1) + 
  labs(x = expression(paste("log(Rosette Area) in time", italic(" t"))), y = expression(paste("Probability of Flowering in time ", italic("  t + 1")))) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 6))

summary(f2)


```


# fecundity - 

```{r}
flbase<- glmer(no.flowersT1 ~ 1 + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
flnull <- glmer(no.flowersT1 ~ log.ros.area + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
anova(flbase, flnull ,test="Chisq") #LTR test

fl1 <- glmer(no.flowersT1 ~ log.ros.area + treatment + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
#nope, no converge

fl2 <- glmer(no.flowersT1 ~ log.ros.area + trt + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
#nope singular fit!

summary(flnull)


```


```{r}


#pflower:
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_point()+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~plot)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_point(aes(size = fruitset))+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~trt)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_point(aes(size = fruitset, color = trt))+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~treatment)
```

#Probability of successfully making seeds ~ treatment*size (data = plants that tried to flower)
```{r}
#of plants that tried to flower, what was their probability of making seeds:
seed <- glmer(as.factor(pseeds) ~ 1 + (1|plot), data = join, family = "binomial")
seed2 <- glmer(as.factor(pseeds) ~ log.ros.area + (1|plot), data = join, family = "binomial")
anova(seed, seed2, test="Chisq") #LTR test

seed3 <- glmer(as.factor(pseeds) ~ log.ros.area + trt + (1|plot), data = join, family = "binomial")

```


#Seed production ~ treatment*size (data = plants that made seeds, this is Poisson)
```{r}
#of plants that made seeds, did that differ between treatment?
noseeds<- glmer(log.total.seeds ~ 1 + (1|plot), data = subset(join, pseeds ==1), family = "poisson")
noseeds1 <- glmer(as.numeric(log.total.seeds) ~ log.ros.area + (1|plot), data = subset(join, pseeds == 1), family = "poisson")
anova(noseeds, noseeds1 ,test="Chisq") #LTR test

noseeds2 <- glmer(total.seeds ~ log.ros.area + trt + (1|plot), data = subset(join, pseeds == 1), family = "poisson")
anova(noseeds1, noseeds2 ,test="Chisq") #LTR test

noseeds3 <- glmer(total.seeds ~ log.ros.area*trt + (1|plot), data = subset(join, pseeds == 1), family = "poisson")
anova(noseeds2, noseeds3 ,test="Chisq") #LTR test

summary(noseeds2)

summary(noseeds3)

```
Great, it's significant - now make a graph

```{r}
ggplot(subset(join, pseeds == 1), aes(log.ros.area, total.seeds))+
  geom_point()+
  geom_smooth(method="glm", method.args=list(family="poisson"), se = F)+
  facet_wrap(~trt)+
  labs()
```

```{r}
#noseeds3
pred.dat.control <-  expand.grid(log.ros.area = seq(0.4, 6, by = .1), trt = "control") #this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.control <- predict(noseeds3, newdata = pred.dat.control, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.control <- as.data.frame(pred.control)
pred.control <- cbind(pred.dat.control, pred.control)

pred.dat.irrigated <-  expand.grid(log.ros.area = seq(0.4, 6, by = .1), trt = "irrigated") #this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.irrigated <- predict(noseeds3, newdata = pred.dat.irrigated, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.irrigated <- as.data.frame(pred.irrigated)
pred.irrigated <- cbind(pred.dat.irrigated, pred.irrigated)

pred.dat.drought <-  expand.grid(log.ros.area = seq(0.4, 6, by = .1), trt = "drought") #this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.drought <- predict(noseeds3, newdata = pred.dat.drought, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.drought <- as.data.frame(pred.drought)
pred.drought <- cbind(pred.dat.drought, pred.drought)

ggplot(subset(join, pseeds == 1), aes(x=log.ros.area, y=total.seeds))+
  geom_jitter(height = 0.025, size = 1, alpha= 0.5) +
  geom_line(data = pred.drought, aes(x = log.ros.area, y = pred.drought), color = Z[5], linewidth = 1) +
  geom_line(data = pred.irrigated, aes(x = log.ros.area, y = pred.irrigated), color = Z[1], linewidth = 1) + 
  geom_line(data = pred.control, aes(x = log.ros.area, y = pred.control), color = Z[3], linewidth = 1) + 
  labs(x = expression(paste("log(Rosette Area) in time", italic(" t"))), y = expression(paste("No. seeds in", italic("  t")))) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 6))
```


