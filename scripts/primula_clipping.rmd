---
title: "Primula Clipping Experiment"
author: "JL"
date: "2/13/2023"
output:
  word_document: default
  html_document: default
---

To do:
- 6/26 update: Met with Jenn, we came up with more ideas:
  - let's take out the vegetative plants, bc we think theyre doing weird things
  - there are more interactions that I didnt try before - we also think that the 
  stepwise selection is wrong, theyre not nested models so it wont work
  - change clipping trt to ln(seeds) and log(fruits produced) - a better measure of reproductive effort! 
  We will have to treat clipping and abortion the same way, which is maybe questionable...
  - ^we can compare which one is better
  - Throw in soil moisture in case that fits better - daily average soil moisutre
  April-end of May
- 7/6 update:
  - Jenny Gremer to the rescue:
  - Go back to LRT but do it in a different way! ( leaving the AIC things, but new stuff is before)

```{r, include = FALSE}
#packages:
#read
library(tidyverse)
library(lubridate)
library(AICcmodavg)
library(lme4)
library(car)
library(wesanderson) # for colors
library(lmerTest)

theme_set(theme_classic()) #for ggplot
FF <- wes_palettes$FantasticFox1
Z <- wes_palettes$Zissou1
R <- wes_palettes$Royal2
I <- wes_palettes$IsleofDogs1
```

```{r}
#read in data, make df's
# Add in demography data:
source("../scripts/dode_allyears_cleaned.R")

#add in tags in clipping experiment
clip <- read.csv("../data/2021_Primula_Clipping.csv")
clip <- clip %>% 
  select(1:8, -c(coor, date.of.clipping)) %>% 
  mutate(tag = as.character(tag),
         plot = as.character(plot),
         initial.flower = no.flowers.at.start +no.buds.at.start)

#adding in soil moisture data
sm <- read.csv("C:/Users/Jenna/Dropbox/Williams' Lab/Students/Jenna/loggerdata/cleaned.data/SM_AprilMayavg_allyears.csv")
sm <- sm %>% mutate(plot = as.character(plot),
                    year = as.character(year))

#add in number of seeds made
seeds21 <- read.csv("C:/Users/Jenna/Dropbox/Williams' Lab/Cowichan IDE/Cowichan_DemographyData/Dodecatheon/2021_Dodecatheon_Seed_Counts.csv")

#In 2021, which flowers made it to being a capsule?
#seeds21 <- subset(seeds21, tag != "1556") # not an experiment plant
#seeds21 <- subset(seeds21, tag != 1998) # not an experiment plant
#seeds21 <- subset(seeds21, tag != 1813)
seeds21 <- seeds21 %>% 
  mutate(pseeds = if_else(no.seeds > 0, 1, 0),
         tag = as.character(tag),
         plot = as.character(plot))
seeds21$pseeds[is.na(seeds21$pseeds)] <- 1 #assuming the plants where we couldn't count capsules separately had all their capsules contribute to seed total


cap <- seeds21 %>% group_by(tag, plot) %>% 
  dplyr::summarize(no.success.cap = sum(pseeds),
            total.seeds = sum(no.seeds))
cap$total.seeds[cap$tag == 1556] <- 29
cap$total.seeds[cap$tag == 1988] <- 58
cap$total.seeds[cap$tag == 1988] <- 58
cap$total.seeds[cap$tag == 282] <- 50
cap$total.seeds[cap$tag == 494] <-98

#adding cap to the clip df

clip <- full_join(clip, cap) %>% 
  mutate(total.seeds = if_else(no.success.cap == 0, 0, total.seeds))
remove(cap)
clip$no.success.cap[is.na(clip$no.success.cap)] <- 0
clip$initial.flower[clip$tag == 1490] <- 6
clip$initial.flower[clip$tag == 5769] <- 5
clip$initial.flower[clip$tag == 962] <- 6
clip$initial.flower[clip$tag == 5746] <- 5
clip$no.success.cap[clip$tag == 540] <- 4
clip$no.success.cap[clip$tag == 693] <- 2



############################################################################
#add in clipping experiment treatments

clip <-  left_join(clip, Dodecatheon, by = c("tag", "plot")) %>% 
  filter(year == 2021) %>% 
  mutate(fruitset = no.success.cap/initial.flower) %>% 
  mutate(pflower = as.factor(pflower),
         rgr = log.ros.areaT1-log.ros.area) #calc relative growth rate

# these are all of the tags in the clipping experiment for 2021 and 2022
#add soil moisture:
clip <- left_join(clip, sm)

#subsetting - get rid of 12 and 14 (only 3 observations per plot - maybe this will help?)
clip <- clip %>% filter(plot != "12") %>% 
  filter(plot != "14")

#this is code to get the vegetative plants back in - unchecked for now
# ###
# # what sizes are plants in 2021 to 2022
# Dodecatheon.21 <- Dodecatheon %>% 
#   filter(year == "2021")
# #of the plants that flowered in 2021, what was their min size? it doesnt look like I need to set a max size
# ggplot(Dodecatheon.21, aes(log.ros.area, log.ros.areaT1, color = pflower)) +
#   geom_jitter()+
#   facet_wrap(~trt)
# ggplot(subset(Dodecatheon.21, !is.na(pflower)), aes(log.ros.area))+
#   geom_histogram()+
#   facet_wrap(pflower~trt)
# min <- Dodecatheon.21 %>% 
#   group_by(pflower, trt) %>% 
#   summarize(min.size = min(log.ros.area, na.rm = TRUE))
# clip2 <- Dodecatheon.21 %>% 
#   filter(log.ros.area > 2) %>% 
#   mutate(pflower = as.factor(pflower))
# join <-  left_join(clip2, clip)
# join <- join %>% 
#   #eft_join(join,sm, by = c("trt", "plot", "year")) %>% 
#   mutate(treatment = if_else(is.na(treatment) & pflower == 0, "veg", if_else(is.na(treatment) & pflower == 1, "flowernt", treatment),  treatment),
#          rgr = log.ros.areaT1-log.ros.area)
# 
# remove(sm, clip2, Dodecatheon, min, Dodecatheon.21)
# 
# #non experiment plants that flowered:
# no.exp <- read.csv("/Users/Jenna/Dropbox/Williams' Lab/Cowichan IDE/Cowichan_DemographyData/Dodecatheon/2021_Dodecatheon_Resurveys.csv", header=T)
# no.exp <- no.exp %>% 
#   filter(!is.na(pseeds)) %>% 
#   dplyr::rename(fruitset1 = pseeds) %>% 
#   select(c(plot, tag, fruitset1)) %>% 
#   mutate(plot = as.character(plot),
#          tag = as.character(tag))


#making a decision here that I may need to change: setting pseeds = fruitset (ie assuming that for these plants, if you made seeds, all of your flowers made seeds) - I have the data to check this, but will go check this later

clip <- clip %>% 
  mutate(log.cap = log(no.success.cap + 1), #because there are zeros 
          total.seeds = if_else(fruitset == 0, 0, total.seeds),
          pseeds = if_else(total.seeds > 0, 1, 0),
          log.total.seeds = log(total.seeds + 1), #because there are zeros 
         psurvivalT1 = if_else(is.na(psurvivalT1), 0, psurvivalT1),
         trt = as.factor(trt)) %>% 
  filter(!is.na(log.total.seeds))
clip <- clip %>%
  select(-c(no.flowers.at.start, no.buds.at.start, tag.pulled, problem.tag, toothpick, lv.length))

clip$trt <- fct_relevel(clip$trt, "drought", "control", "irrigated")

#clip.sub filtered out the plots with very few observations

```

```{r}
ggplot(clip, aes(x = log.ros.area, y = log.ros.areaT1))+
  geom_point()+
  geom_smooth(method = "lm", se = F)+
  geom_abline(slope=1, intercept=0)+
  facet_wrap(~plot)
ggplot(clip, aes(x = log.ros.area, y = pflowerT1))+
  geom_point()+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+  
  geom_abline(slope=1, intercept=0)+
  facet_wrap(~plot)
```


#Fig 2:
Boxplot for number of seeds made across clipping treatment

```{r}
no.seeds.boxplot.trt <- 
  ggplot(subset(clip, !is.na(treatment)), aes(treatment, log.total.seeds, color = trt))+
  geom_boxplot(aes(color = trt))+
  #facet_wrap(~trt)+
  scale_color_manual(values = c(Z[5], Z[3], Z[1]))+
  labs(y = "Log(total seeds)", x = "Number of flowers clipped")+
  theme(legend.title=element_blank())
no.seeds.boxplot.trt

#ggsave(plot = no.seeds.boxplot.trt, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/no.seeds.boxplot.trt.png", width = 8, height = 6, dpi = 300)

#no.seeds.boxplot <- 
  ggplot(subset(clip, !is.na(treatment)), aes(treatment, log.total.seeds))+
  geom_boxplot()+
  scale_color_manual(values = c(Z[3], Z[5], Z[1]))+
  labs(y = "Log(total seeds)", x = "Number of flowers clipped")
no.seeds.boxplot
#ggsave(plot = no.seeds.boxplot, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/no.seeds.boxplot.png", width = 6, height = 6, dpi = 300)
```



#_ROUND 3 LRT:_
Notes from Jenn's meeting with Jenny Gremer:
"Meeting with Jenny G – July 5, 2023

Vital rate (in t+1) ~ size t + cliptrt (or #seeds t) + preciptrt + cliptrt* preciptrt + size*cliptrt + size*preciptrt + size*cliptrt*preciptrt + (1|plot)

Responses: Size(t+1), p(flower t+1), number flowers(t+1), survival(t+1)

Model selection vs. hypothesis testing – we really do have hypotheses! We want to know if these things matter more than we want to find the best model.

Jenna also tried soil moisture reading/plot (instead of preciptrt) solve this first -->

Use likelihood ratio tests (nested models) as anova. Start with big model (3 way interaction gets at the crux of what we want to know) – how does status influence costs of reproduction? Run full model, take out 3 way interaction, compare with LL ratio test. (anova (m1, m2, test=LRT?)). Take out 2 way interactions one at a time, then test each of those (models 3, 4, 5 are taking out pairwise interactions with full replacement – comparing to model with all the 2-way interactions. Save stats into table as you go (in some way or another, could be as simple as a dataframe you fill.)

If interactions are significant, keep main effects – this approach is good because if interactions are significant, then main effects may not be. And worry less about the singular problem.
 
(probably people would have used model selection 20 years ago when it was new – not so useful for an experiment!"

-> We used likelihood ratio tests on nested models to evaluate the significance of main effects (if p>0.05 -> coefficient removed is not significant)
Null-hypothesis testing is (relatively) easy: just fit the nested models (with
and without the focal parameter fixed to zero) and find the p (tail) value
associated with χ
2
1
for the deviance difference (−2 × ∆ log L) (remember
not to use REML estimates!)
interpretation of the results that the model with the least df gets preferred in case of a significant difference.???
likelihood ratio tests comparing two models (one with and without a predictor) should be performed to determine whether a variable of interest is statistically significant, rather than using the p-values for estimates of individual predictors from the summary() function of a linear model.
A significant likelihood ratio test would be an indication that the model that has A as a predictor provides a better fit to your data whereas an insignificant likelihood ratio test would indicate that A is not needed to model the outcome C. 

A likelihood ratio test tests whether the additional parameters present in the larger model are jointly different from zero (i.e., whether any of them are different from zero). Failing to reject the null hypothesis indicates that the smaller model is to be preferred. For you, this is model 1.

Significance of fixed effects was assessed with likelihood ratio tests and DAIC values comparing models with each factor added to or removed from the best fit model
(one can estimate confidence intervals by parametric bootstrapping — that is, by simulating data from the fitted model, refitting the model, and extracting the new estimated parameters (or any other quantities of interest))
we used likelihood ratio tests (LRTs) as an addi- tional method to quantify the difference between models with or without traits. A significant χ2 value (p< 0.05) from an LRT indicated that including trait values signifi- cantly changes model fit.
The inset tables show the results of a likelihood ratio test comparing a model accounting for covariates to a simpler model that ignores the covariates. P < 0.05 indicates significant support for the more complex model.

The significance of each fixed effect in the best-fit model was tested using likelihood ratio tests on nested models. The

Can't use LRT for models comparing fixed effects and interactions: don’t test main effects at all in the presence of interactions (Ben Bolker) - https://bbolker.github.io/stat4c03/notes/inference.pdf


```{r growth LRT}
growth_LRT = data.frame(var = NA,
                        chi = NA, 
                        pvalue = NA)
#colnames(growth_LRT) <- c("var", "chi", "p-value")

growth_full <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, REML= F)
growth_no3way <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, REML= F)
a1 <- anova(growth_full, growth_no3way, test="LRT") #LRT test - removing 3 way interaction does not significantly change model
growth_LRT[1,] <- c("size:seeds:trt", a1[2,6], a1[2,8])


growth_no.seed.trt <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, REML= F)
a2 <- anova(growth_no3way, growth_no.seed.trt, test="LRT") #LRT test - removing seed:trt interaction does not significantly change model
growth_LRT[2,] <- c("seeds:trt", a2[2,6], a2[2,8])

growth_no.size.seeds <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:trt + (1|plot), data = clip, REML= F)
a3 <- anova(growth_no3way, growth_no.size.seeds, test="LRT") #LRT test - removing size:seed interaction does not significantly change model
growth_LRT[3,] <- c("size:seed", a3[2,6], a3[2,8])


growth_no.size.trt <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + (1|plot), data = clip, REML= F)
a4 <- anova(growth_no3way, growth_no.size.trt, test="LRT") #LRT test - removing size:trt does not significantly change model
growth_LRT[4,] <- c("size:trt", a4[2,6], a4[2,8])

#the above seem fine, but not sure what to do with these - Jenn and i talked about then just dropping terms from this model and not comparing this model to the one with interactions
growth_no.int <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + trt + (1|plot), data = clip, REML= F)
growth_no.seeds <- lmer(log.ros.areaT1 ~ log.ros.area + trt + (1|plot), data = clip, REML= F)
a5 <- anova(growth_no.int, growth_no.seeds, test="LRT") #LRT test
growth_LRT[5,] <- c("totalseeds", a5[2,6], a5[2,8])
# 
# 
growth_no.trt <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + (1|plot), data = clip, REML= F)
a6 <- anova(growth_no.trt, growth_no.int , test="LRT") #LRT test
growth_LRT[6,] <- c("trt", a6[2,6], a6[2,8])

# 
growth_alone <- lmer(log.ros.areaT1 ~ log.ros.area + (1|plot), data = clip, REML= F)
a7 <- anova(growth_no.trt, growth_alone , test="LRT") #LRT test
a8 <- anova(growth_no.seeds, growth_alone , test="LRT")
a9 <- anova(growth_no.int, growth_alone , test="LRT")


a7
a8
a9

#growth_LRT[7,] <- c("trt", a7[2,6], a7[2,8])

# 
# 
#write.csv(x = growth_LRT, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/round 3/growth_LRT.csv")

drop1(growth_no.int,test="Chisq")

#parametric bootstrapping
#pbnmx1 <- pbnm(growth_no.int,gmmDx1,nsim=5,tasks=10,cores=2,seed=31221743)
#summary(pbnmx1)
```


```{r plower}
pflower_LRT = data.frame(var = NA,
                        chi = NA, 
                        pvalue = NA)
#colnames(pflower_LRT) <- c("var", "chi", "p-value")

pflower_full <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "binomial")
pflower_no3way <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
a1 <- anova(pflower_full, pflower_no3way, test="LRT") #LRT test - removing 3 way interaction does not significantly change model
pflower_LRT[1,] <- c("size:seeds:trt", a1[2,6], a1[2,8])


pflower_no.seed.trt <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
a2 <- anova(pflower_no3way, pflower_no.seed.trt, test="LRT") #LRT test - removing seed:trt interaction does not significantly change model
pflower_LRT[2,] <- c("seeds:trt", a2[2,6], a2[2,8])

pflower_no.size.seeds <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
a3 <- anova(pflower_no3way, pflower_no.size.seeds, test="LRT") #LRT test - removing size:seed interaction does not significantly change model
pflower_LRT[3,] <- c("size:seed", a3[2,6], a3[2,8])


pflower_no.size.trt <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + (1|plot), data = clip, family = "binomial")
a4 <- anova(pflower_no3way, pflower_no.size.trt, test="LRT") #LRT test - removing size:trt does not significantly change model
pflower_LRT[4,] <- c("size:trt", a4[2,6], a4[2,8])

pflower_no.int <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + trt + (1|plot), data = clip, family = "binomial")
pflower_no.trt <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + (1|plot), data = clip, family = "binomial")

a5 <- anova(pflower_no.int, pflower_no.trt, test="LRT") #LRT test - removing size:trt does not significantly change model
pflower_LRT[5,] <- c("trt", a5[2,6], a5[2,8])

pflower_no.seeds <- glmer(pflowerT1 ~ log.ros.area + trt + (1|plot), data = clip, family = "binomial")
a6 <- anova(pflower_no.int, pflower_no.seeds, test="LRT")
pflower_LRT[6,] <- c("totalseeds", a6[2,6], a6[2,8])


pflower_sizealone <- glmer(pflowerT1 ~ log.ros.area + (1|plot), data = clip, family = "binomial")
anova(pflower_no.seeds, pflower_sizealone, test="LRT")


#write.csv(x = pflower_LRT, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/round 3/pflower_LRT.csv")

drop1(pflower_no3way, test = "Chisq")
```



```{r survival}
survival_LRT = data.frame(var = NA,
                        chi = NA, 
                        pvalue = NA)
#colnames(survival_LRT) <- c("var", "chi", "p-value")

survival_full <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "binomial")
survival_no3way <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
a1 <- anova(survival_full, survival_no3way, test="LRT") #LRT test - removing 3 way interaction does not significantly change model
survival_LRT[1,] <- c("size:seeds:trt", a1[2,6], a1[2,8])


survival_no.seed.trt <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
a2 <- anova(survival_no3way, survival_no.seed.trt, test="LRT") #LRT test - removing seed:trt interaction does not significantly change model
survival_LRT[2,] <- c("seeds:trt", a2[2,6], a2[2,8])

survival_no.size.seeds <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
a3 <- anova(survival_no3way, survival_no.size.seeds, test="LRT") #LRT test - removing size:seed interaction does not significantly change model
survival_LRT[3,] <- c("size:seed", a3[2,6], a3[2,8])


survival_no.size.trt <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + (1|plot), data = clip, family = "binomial")
a4 <- anova(survival_no3way, survival_no.size.trt, test="LRT") #LRT test - removing size:trt does not significantly change model
survival_LRT[4,] <- c("size:trt", a4[2,6], a4[2,8])

survival_no.int <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + trt + (1|plot), data = clip, family = "binomial")
survival_no.seeds <- glmer(psurvivalT1 ~ log.ros.area + trt + (1|plot), data = clip, family = "binomial")
survival_no.trt <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + (1|plot), data = clip, family = "binomial")

a5 <- anova(survival_no.int, survival_no.seeds, test="LRT") #LRT test - removing size:trt does not significantly change model
survival_LRT[5,] <- c("totalseeds", NA, NA) #model has weird errors
a6 <- anova(survival_no.int, survival_no.trt, test="LRT") #LRT test - removing size:trt does not significantly change model
survival_LRT[6,] <- c("trt", NA, NA) #model has weird errors

#write.csv(x = survival_LRT, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/round 3/survival_LRT.csv")
```

```{r no.flowers}
no.flowers_LRT = data.frame(var = NA,
                        chi = NA, 
                        pvalue = NA)
#colnames(no.flowers_LRT) <- c("var", "chi", "p-value")

no.flowers_full <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "poisson")
no.flowers_no3way <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "poisson")
a1 <- anova(no.flowers_full, no.flowers_no3way, test="LRT") #LRT test - removing 3 way interaction does not significantly change model
no.flowers_LRT[1,] <- c("size:seeds:trt", a1[2,6], a1[2,8])


no.flowers_no.seed.trt <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + trt + log.ros.area:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "poisson")
a2 <- anova(no.flowers_no3way, no.flowers_no.seed.trt, test="LRT") #LRT test - removing seed:trt interaction does not significantly change model
no.flowers_LRT[2,] <- c("seeds:trt", a2[2,6], a2[2,8])

no.flowers_no.size.seeds <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:trt + (1|plot), data = clip, family = "poisson")
a3 <- anova(no.flowers_no3way, no.flowers_no.size.seeds, test="LRT") #LRT test - removing size:seed interaction does not significantly change model
no.flowers_LRT[3,] <- c("size:seed", a3[2,6], a3[2,8])


no.flowers_no.size.trt <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + (1|plot), data = clip, family = "poisson")
a4 <- anova(no.flowers_no3way, no.flowers_no.size.trt, test="LRT") #LRT test - removing size:trt does not significantly change model
no.flowers_LRT[4,] <- c("size:trt", a4[2,6], a4[2,8])

no.flowers_no.int <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + trt + (1|plot), data = clip, family = "poisson")
no.flowers_no.seeds <- glmer(no.flowersT1 ~ log.ros.area + trt + (1|plot), data = clip, family = "poisson")
no.flowers_no.trt <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + (1|plot), data = clip, family = "poisson")

a5 <- anova(no.flowers_no.int, no.flowers_no.trt, test="LRT") #LRT test
no.flowers_LRT[5,] <- c("trt", a5[2,6], a5[2,8])
a6 <- anova(no.flowers_no.int, no.flowers_no.seeds, test="LRT") #LRT test
no.flowers_LRT[6,] <- c("totalseeds", a6[2,6], a6[2,8])


no.flowers_no.seeds <- glmer(no.flowersT1 ~ log.ros.area + trt + (1|plot), data = clip, family = "poisson")

#write.csv(x = no.flowers_LRT, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/round 3/no.flowers_LRT.csv")
```


##_ROUND 2_

#These are the vital rate models we want to build:

```{r growth model selection}
growth.01 <- lmer(log.ros.areaT1 ~ log.ros.area +(1|plot), data = clip, REML = F)
growth.02 <- lmer(log.ros.areaT1 ~ log.ros.area*trt +(1|plot), data = clip, REML= F)
growth.03 <- lmer(log.ros.areaT1 ~ log.ros.area + trt + log.total.seeds + (1|plot), data = clip, REML= F)
growth.04 <- lmer(log.ros.areaT1 ~ log.ros.area + trt + log.total.seeds + trt:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, REML= F)
growth.05 <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, REML= F)

growth.06 <- lmer(log.ros.areaT1 ~ log.ros.area + trt + log.cap + (1|plot), data = clip, REML= F)
growth.07 <- lmer(log.ros.areaT1 ~ log.ros.area + trt + log.cap + trt:log.cap + log.ros.area:trt + (1|plot), data = clip, REML= F)
growth.08 <- lmer(log.ros.areaT1 ~ log.ros.area + log.cap + trt + log.cap:trt + log.ros.area:log.cap + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, REML= F)

#add in SM data for fun
growth.09 <- lmer(log.ros.areaT1 ~ log.ros.area*sm_avg +(1|plot), data = clip, REML= F)
growth.10 <- lmer(log.ros.areaT1 ~ log.ros.area + sm_avg + log.total.seeds + (1|plot), data = clip, REML= F)
growth.11 <- lmer(log.ros.areaT1 ~ log.ros.area + sm_avg + log.total.seeds + sm_avg:log.total.seeds + log.ros.area:sm_avg + (1|plot), data = clip, REML= F)
growth.12 <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + sm_avg + log.total.seeds:sm_avg + log.ros.area:log.total.seeds + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, REML= F)

growth.13 <- lmer(log.ros.areaT1 ~ log.ros.area + sm_avg + log.cap + (1|plot), data = clip, REML= F)
growth.14 <- lmer(log.ros.areaT1 ~ log.ros.area + sm_avg + log.cap + sm_avg:log.cap + log.ros.area:sm_avg + (1|plot), data = clip, REML= F)
growth.15 <- lmer(log.ros.areaT1 ~ log.ros.area + log.cap + sm_avg + log.cap:sm_avg + log.ros.area:log.cap + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, REML= F)
growth.16 <- lmer(log.ros.areaT1 ~ log.ros.area + log.total.seeds + (1|plot), data = clip, REML= F)
growth.17 <- lmer(log.ros.areaT1 ~ log.ros.area*log.total.seeds + (1|plot), data = clip, REML= F)
growth.18 <- lmer(log.ros.areaT1 ~ log.ros.area + log.cap + (1|plot), data = clip, REML= F)
growth.19 <- lmer(log.ros.areaT1 ~ log.ros.area*log.cap + (1|plot), data = clip, REML= F)

model.names = c("log(size)", 
                "log(size)*IDE", 
                "log(size) + IDE + log(total seeds)", 
                "log(size) + IDE + log(total seeds) + IDE:log(total seeds) + log(size):IDE",
                "log(size) + log(total seeds) + IDE + log(total seeds):IDE + log(size):log(total seeds) + log(size):IDE + log(size):log(total seeds):IDE",
                "log(size) + IDE + log(total capsules)",
                "log(size) + IDE + log(total capsules) + IDE:log(total capsules) + log(size):IDE",
                "log(size) + log(total capsules) + IDE + log(total capsules):IDE + log(size):log(total capsules) + log(size):IDE + log(size):log(total seeds):IDE",
                "log(size)*soil moisture",
                "log(size) + soil moisture + log(total seeds)",
                "log(size) + soil moisture + log(total seeds) + soil moisture:log(total seeds) + log(size):soil moisture",
                "log(size) + log(total seeds) + soil moisture + log(total seeds):soil moisture + log(size):log(total seeds) + log(size):soil moisture + log(size):log(total seeds):soil moisture",
                "log(size) + soil moisture + log(total capsules)",
                "log(size) + soil moisture + log(total capsules) + soil moisture:log(total capsules) + log(size):soil moisture",
                "log(size) + log(total capsules) + soil moisture + log(total capsules):soil moisture + log(size):log(total capsules) + log(size):soil moisture + log(size):log(total seeds):soil moisture",
                "log(size) + log(total seeds)",
                "log(size)*log(total seeds)",
                "log(size) + log(total capsules)",
                "log(size)*log(total capsules)")

gr.mods <- mget(ls(pattern = "growth")) #make a list of all of those models that start with gm (^ means start with)
gr_AICc<-aictab(cand.set = gr.mods, modnames = model.names,second.ord=TRUE,nobs=NULL,sort=TRUE)
#test<-aictab(cand.set = gr.mods, modnames = NULL,second.ord=TRUE,nobs=NULL,sort=TRUE)
gr.AIC <- as.data.frame(gr_AICc)
#write.csv(x = gr.AIC, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/growth AIC table.csv")


summary(growth.16)
#rm(list = ls()[grepl("growth", ls())]) #removes these models
```


```{r growth best fit model log.ros.area + log.total.seeds}
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), log.total.seeds = seq(0, 5.3, by = .1))
pred.output <- predict(growth.16, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(log.ros.areaT1 = pred.output)

#graph it
growth <- ggplot(clip, aes(x = log.ros.area, y = log.ros.areaT1))+
  geom_abline(slope=1, intercept = 0, linetype = 2, color= "grey", size = 1)+
  geom_point()+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 5), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid4", size = 1.25)+
  #geom_line(data = subset(pred.dat.output, log.total.seeds == 4), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid3")+
  #geom_line(data = subset(pred.dat.output, log.total.seeds == 3), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid2", linetype = "longdash", size = 1)+
 # geom_line(data = subset(pred.dat.output, log.total.seeds == 2), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid1")+
  geom_line(data = subset(pred.dat.output,  log.total.seeds == 1), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid1", linetype = "longdash", size = 1.25)+
 # geom_line(data = subset(pred.dat.output, log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = "grey")+
  #scale_y_continuous(expand = c(0, 0), limits = c(0, 6))+
  #scale_x_continuous(expand = c(0, 0), limits = c(0, 6))+
  labs(x = "log(Rosette Area) in 2021", y = "log(Rosette Area) in 2022")
growth
ggsave(plot = growth, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/growth3 for pres.png", width = 4, height = 4, dpi = 300)
```

```{r growth figures - 2nd lowest AIC - log.ros.area + sm_avg + log.total.seeds}
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), sm_avg = seq(.1, .25, by = .01), log.total.seeds = seq(0, 5.3, by = .1))
pred.output <- predict(growth.10, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(log.ros.areaT1 = pred.output)

#graph it
ggplot(clip, aes(x = log.ros.area, y = log.ros.areaT1))+
  geom_point()+
  geom_line(data = subset(pred.dat.output, sm_avg == .25 & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[1], size = 1)+
  geom_line(data = subset(pred.dat.output, sm_avg == .13 & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[3], size = 1)+
  geom_line(data = subset(pred.dat.output, sm_avg == .1 & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[5], size = 1)+
  geom_line(data = subset(pred.dat.output, sm_avg == .25 & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1),  linetype = "dashed", color = Z[1])+
  geom_line(data = subset(pred.dat.output, sm_avg == .13 & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[3], linetype = "dashed", size = 1)+
  geom_line(data = subset(pred.dat.output, sm_avg == .1 & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[5], linetype = "dashed", size = 1)+
    geom_abline(slope=1, intercept = 0, linetype = 2, color= "grey", size = 1)+
    scale_y_continuous(expand = c(0, 0), limits = c(0, 6))+
  scale_x_continuous(expand = c(0, 0), limits = c(0, 6))+
  labs(x = "log(Rosette Area) in 2021", y = "log(Rosette Area) in 2022")

#these seem kind of weird - I think the interaction may make more sense
```


```{r growth figure 3 - log.ros.area + trt + log.total.seeds, include=FALSE}
#create df with all possible x values
#this is for model without an interaction
# pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), trt = c("irrigated", "control", "drought"), log.total.seeds = seq(0, 5.3, by = .1))
# pred.output <- predict(growth.3, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
# pred.output <- as.data.frame(pred.output)
# pred.dat.output <- cbind(pred.dat, pred.output) %>% 
#   rename(log.ros.areaT1 = pred.output)
# 
# #graph it
# ggplot(clip, aes(x = log.ros.area, y = log.ros.areaT1))+
#   geom_point()+
#   geom_line(data = subset(pred.dat.output, trt == "irrigated" & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[1])+
#   geom_line(data = subset(pred.dat.output,  trt == "control" & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[3], size = 1)+
#   geom_line(data = subset(pred.dat.output, trt == "drought" & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[5], size = 1)+
#   geom_line(data = subset(pred.dat.output,  trt == "irrigated" & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1),  linetype = "dashed", color = Z[1])+
#   geom_line(data = subset(pred.dat.output, trt == "control" & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[3], linetype = "dashed", size = 1)+
#   geom_line(data = subset(pred.dat.output, trt == "drought" & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[5], linetype = "dashed", size = 1)+
#       geom_abline(slope=1, intercept = 0, linetype = 2, color= "grey", size = 1)+
#     scale_y_continuous(expand = c(0, 0), limits = c(0, 6))+
#   scale_x_continuous(expand = c(0, 0), limits = c(0, 6))+
#   labs(x = "log(Rosette Area) in 2021", y = "log(Rosette Area) in 2022")
# #why would drought grow more? but plants that make seeds are smaller than plants that make seeds! so that's something
```
```{r pflower model selection}
pf.01 <- glmer(pflowerT1 ~ log.ros.area +(1|plot), data = clip, family = "binomial")
pf.02 <- glmer(pflowerT1 ~ log.ros.area*trt +(1|plot), data = clip, family = "binomial")
pf.03 <- glmer(pflowerT1 ~ log.ros.area + trt + log.total.seeds + (1|plot), data = clip, family = "binomial")
pf.04 <- glmer(pflowerT1 ~ log.ros.area + trt + log.total.seeds + trt:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
pf.05 <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "binomial")

pf.06 <- glmer(pflowerT1 ~ log.ros.area + trt + log.cap + (1|plot), data = clip, family = "binomial")
pf.07 <- glmer(pflowerT1 ~ log.ros.area + trt + log.cap + trt:log.cap + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
pf.08 <- glmer(pflowerT1 ~ log.ros.area + log.cap + trt + log.cap:trt + log.ros.area:log.cap + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "binomial")

pf.09 <- glmer(pflowerT1 ~ log.ros.area*sm_avg +(1|plot), data = clip, family = "binomial")
pf.10 <- glmer(pflowerT1 ~ log.ros.area + sm_avg + log.total.seeds + (1|plot), data = clip, family = "binomial")
pf.11 <- glmer(pflowerT1 ~ log.ros.area + sm_avg + log.total.seeds + sm_avg:log.total.seeds + log.ros.area:sm_avg + (1|plot), data = clip, family = "binomial")
pf.12 <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds + sm_avg + log.total.seeds:sm_avg + log.ros.area:log.total.seeds + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, family = "binomial")

pf.13 <- glmer(pflowerT1 ~ log.ros.area + sm_avg + log.cap + (1|plot), data = clip, family = "binomial")
pf.14 <- glmer(pflowerT1 ~ log.ros.area + sm_avg + log.cap + sm_avg:log.cap + log.ros.area:sm_avg + (1|plot), data = clip, family = "binomial")
pf.15 <- glmer(pflowerT1 ~ log.ros.area + log.cap + sm_avg + log.cap:sm_avg + log.ros.area:log.cap + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, family = "binomial")

pf.16 <- glmer(pflowerT1 ~ log.ros.area + log.total.seeds +(1|plot), data = clip, family = "binomial")
pf.17 <- glmer(pflowerT1 ~ log.ros.area*log.total.seeds +(1|plot), data = clip, family = "binomial")
pf.18 <- glmer(pflowerT1 ~ log.ros.area + log.cap +(1|plot), data = clip, family = "binomial")
pf.19 <- glmer(pflowerT1 ~ log.ros.area*log.cap +(1|plot), data = clip, family = "binomial")

pflower <- mget(ls(pattern = "pf")) #make a list of all of those models that start with gm (^ means start with)
pflower_AICc<-aictab(cand.set = pflower, modnames = model.names,second.ord=TRUE,nobs=NULL,sort=TRUE)
pflower.AIC <- as.data.frame(pflower_AICc)

#write.csv(x = pflower.AIC, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/pflower AIC table.csv")
#rm(list = ls()[grepl("pflower", ls())]) #removes these models
summary(pf.16)
```

```{r pflower best fit model}
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), log.total.seeds = seq(0, 5.3, by = .1))
pred.output <- predict(pf.16, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(log.ros.areaT1 = pred.output)

pflower.fig <- ggplot(clip, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .01)+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 5), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid4", size = 1.25)+
  #geom_line(data = subset(pred.dat.output, log.total.seeds == 4), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid3")+
  #geom_line(data = subset(pred.dat.output, log.total.seeds == 3), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid2", linetype = "longdash", size = 1)+
  #geom_line(data = subset(pred.dat.output, log.total.seeds == 2), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid1")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 1), aes(x = log.ros.area, y = log.ros.areaT1), color = "darkorchid1", linetype = "longdash", size = 1.25)+
  #geom_line(data = subset(pred.dat.output, log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = "grey")+
  #scale_x_continuous(expand = c(0, 0), limits = c(0, 6))+
  labs(x = "log(Rosette Area) in 2021", y = "Probability of Flowering in 2022")
pflower.fig

#ggsave(plot = pflower.fig, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/pflower.png", width = 4, height = 4, dpi = 300)
```

```{r pflower fig 1 - pf.3}
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), trt = c("irrigated", "control", "drought"), log.total.seeds = seq(0, 5.3, by = .1))
pred.output <- predict(pf.03, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(log.ros.areaT1 = pred.output)

ggplot(clip, aes(x = log.ros.area, y = pflowerT1))+
  geom_point()+
  geom_line(data = subset(pred.dat.output, trt == "irrigated" & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[1])+
  geom_line(data = subset(pred.dat.output,  trt == "control" & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[3], size = 1)+
  geom_line(data = subset(pred.dat.output, trt == "drought" & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[5], size = 1)+
  geom_line(data = subset(pred.dat.output,  trt == "irrigated" & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1),  linetype = "dashed", color = Z[1])+
  geom_line(data = subset(pred.dat.output, trt == "control" & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[3], linetype = "dashed", size = 1)+
  geom_line(data = subset(pred.dat.output, trt == "drought" & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = Z[5], linetype = "dashed", size = 1)


```
```{r pflower fig 1 - pf.11 - this one wasnt singular}
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), sm_avg = seq(.1, .25, by = .01), log.total.seeds = seq(0, 5.3, by = .1))
pred.output <- predict(pf.11, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(log.ros.areaT1 = pred.output)

ggplot(clip, aes(x = log.ros.area, y = pflowerT1))+
  geom_point()+
  geom_line(data = subset(pred.dat.output, sm_avg == .25 & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = "blue")+
  geom_line(data = subset(pred.dat.output,  sm_avg == .13 & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = "grey", size = 1)+
  geom_line(data = subset(pred.dat.output, sm_avg == .1 & log.total.seeds == 5.3), aes(x = log.ros.area, y = log.ros.areaT1), color = "red", size = 1)+
  geom_line(data = subset(pred.dat.output,  sm_avg == .25 & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1),  linetype = "dashed", color = "blue")+
  geom_line(data = subset(pred.dat.output, sm_avg == .13 & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = "grey", linetype = "dashed", size = 1)+
  geom_line(data = subset(pred.dat.output, sm_avg == .1 & log.total.seeds == 0), aes(x = log.ros.area, y = log.ros.areaT1), color = "red", linetype = "dashed", size = 1)

#why are  plants that make more seeds more likely to flower the next year. What to do???
```

```{r poisson}
nof.01 <- glmer(no.flowersT1 ~ log.ros.area + (1|plot), data = clip, family = "poisson")
nof.02 <- glmer(no.flowersT1 ~ log.ros.area*trt + (1|plot), data = clip, family = "poisson")
nof.03 <- glmer(no.flowersT1 ~ log.ros.area + trt + log.total.seeds + (1|plot), data = clip, family = "poisson")
nof.04 <- glmer(no.flowersT1 ~ log.ros.area + trt + log.total.seeds + trt:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "poisson")
nof.05 <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "poisson")

nof.06 <- glmer(no.flowersT1 ~ log.ros.area + trt + log.cap + (1|plot), data = clip, family = "poisson")
nof.07 <- glmer(no.flowersT1 ~ log.ros.area + trt + log.cap + trt:log.cap + log.ros.area:trt + (1|plot), data = clip, family = "poisson")
nof.08 <- glmer(no.flowersT1 ~ log.ros.area + log.cap + trt + log.cap:trt + log.ros.area:log.cap + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "poisson")

nof.09 <- glmer(no.flowersT1 ~ log.ros.area*sm_avg + (1|plot), data = clip, family = "poisson")
nof.10 <- glmer(no.flowersT1 ~ log.ros.area + sm_avg + log.total.seeds + (1|plot), data = clip, family = "poisson")
nof.11 <- glmer(no.flowersT1 ~ log.ros.area + sm_avg + log.total.seeds + sm_avg:log.total.seeds + log.ros.area:sm_avg + (1|plot), data = clip, family = "poisson")
nof.12 <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + sm_avg + log.total.seeds:sm_avg + log.ros.area:log.total.seeds + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, family = "poisson")

nof.13 <- glmer(no.flowersT1 ~ log.ros.area + sm_avg + log.cap + (1|plot), data = clip, family = "poisson")
nof.14 <- glmer(no.flowersT1 ~ log.ros.area + sm_avg + log.cap + sm_avg:log.cap + log.ros.area:sm_avg + (1|plot), data = clip, family = "poisson")
nof.15 <- glmer(no.flowersT1 ~ log.ros.area + log.cap + sm_avg + log.cap:sm_avg + log.ros.area:log.cap + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, family = "poisson")
nof.16 <- glmer(no.flowersT1 ~ log.ros.area + log.total.seeds + (1|plot), data = clip, family = "poisson")
nof.17 <- glmer(no.flowersT1 ~ log.ros.area*log.total.seeds + (1|plot), data = clip, family = "poisson")
nof.18 <- glmer(no.flowersT1 ~ log.ros.area + log.cap + (1|plot), data = clip, family = "poisson")
nof.19 <- glmer(no.flowersT1 ~ log.ros.area*log.cap + (1|plot), data = clip, family = "poisson")


flowers <- mget(ls(pattern = "nof.")) #make a list of all of those models that start with gm (^ means start with)
flowers_AICc<-aictab(cand.set = flowers, modnames = model.names,second.ord=TRUE,nobs=NULL,sort=TRUE)
noflower.AIC <- as.data.frame(flowers_AICc)
#write.csv(x = noflower.AIC, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/no.flower AIC table.csv")
#rm(list = ls()[grepl("flowers", ls())]) #removes these models
summary(nof.16)
```

```{r poisson fig 1 - best fit, but singular! }
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), log.total.seeds = seq(0, 5.3, by = .1))
pred.output <- predict(nof.16, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(no.flowersT1 = pred.output)

no.flowers <- ggplot(clip, aes(x = log.ros.area, y = no.flowersT1))+
  geom_point()+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 5), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid4")+
  geom_line(data = subset(pred.dat.output,  log.total.seeds == 4), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid3")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 3), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid2")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 2), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid1")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 1), aes(x = log.ros.area, y = no.flowersT1), color = "violet")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 0), aes(x = log.ros.area, y = no.flowersT1), color = "grey")+
  scale_x_continuous(expand = c(0, 0), limits = c(0, 6))+
  labs(x = "log(Rosette Area) in 2021", y = "No. flowers in 2022")

no.flowers
#ggsave(plot = no.flowers, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/no.flower.png", width = 6, height = 6, dpi = 300)


#this seems reasonable...but is a singular fit!
```

```{r poisson fig 1 -int}
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1), log.total.seeds = seq(0, 5.3, by = .1))
pred.output <- predict(nof.17, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(no.flowersT1 = pred.output)

no.flowers1 <- ggplot(clip, aes(x = log.ros.area, y = no.flowersT1))+
  geom_point()+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 5), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid4")+
  geom_line(data = subset(pred.dat.output,  log.total.seeds == 4), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid3")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 3), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid2")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 2), aes(x = log.ros.area, y = no.flowersT1), color = "darkorchid1")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 1), aes(x = log.ros.area, y = no.flowersT1), color = "violet")+
  geom_line(data = subset(pred.dat.output, log.total.seeds == 0), aes(x = log.ros.area, y = no.flowersT1), color = "grey")+
  scale_x_continuous(expand = c(0, 0), limits = c(0, 6))+
  labs(x = "log(Rosette Area) in 2021", y = "No. flowers in 2022")

no.flowers1
#ggsave(plot = no.flowers1, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/no.flower.png", width = 6, height = 6, dpi = 300)


#this seems reasonable...but is a singular fit!
```

```{r survival}
sur.01 <- glmer(psurvivalT1 ~ log.ros.area +(1|plot), data = clip, family = "binomial")
sur.02 <- glmer(psurvivalT1 ~ log.ros.area*trt +(1|plot), data = clip, family = "binomial")
sur.03 <- glmer(psurvivalT1 ~ log.ros.area + trt + log.total.seeds + (1|plot), data = clip, family = "binomial")
sur.04 <- glmer(psurvivalT1 ~ log.ros.area + trt + log.total.seeds + trt:log.total.seeds + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
sur.05 <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + trt + log.total.seeds:trt + log.ros.area:log.total.seeds + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "binomial")

sur.06 <- glmer(psurvivalT1 ~ log.ros.area + trt + log.cap + (1|plot), data = clip, family = "binomial")
sur.07 <- glmer(psurvivalT1 ~ log.ros.area + trt + log.cap + trt:log.cap + log.ros.area:trt + (1|plot), data = clip, family = "binomial")
sur.08 <- glmer(psurvivalT1 ~ log.ros.area + log.cap + trt + log.cap:trt + log.ros.area:log.cap + log.ros.area:trt + log.ros.area:log.total.seeds:trt + (1|plot), data = clip, family = "binomial")

sur.09 <- glmer(psurvivalT1 ~ log.ros.area*sm_avg +(1|plot), data = clip, family = "binomial")
sur.10 <- glmer(psurvivalT1 ~ log.ros.area + sm_avg + log.total.seeds + (1|plot), data = clip, family = "binomial")
sur.11 <- glmer(psurvivalT1 ~ log.ros.area + sm_avg + log.total.seeds + sm_avg:log.total.seeds + log.ros.area:sm_avg + (1|plot), data = clip, family = "binomial")
sur.12 <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + sm_avg + log.total.seeds:sm_avg + log.ros.area:log.total.seeds + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, family = "binomial")

sur.13 <- glmer(psurvivalT1 ~ log.ros.area + sm_avg + log.cap + (1|plot), data = clip, family = "binomial")
sur.14 <- glmer(psurvivalT1 ~ log.ros.area + sm_avg + log.cap + sm_avg:log.cap + log.ros.area:sm_avg + (1|plot), data = clip, family = "binomial")
sur.15 <- glmer(psurvivalT1 ~ log.ros.area + log.cap + sm_avg + log.cap:sm_avg + log.ros.area:log.cap + log.ros.area:sm_avg + log.ros.area:log.total.seeds:sm_avg + (1|plot), data = clip, family = "binomial")

sur.16 <- glmer(psurvivalT1 ~ log.ros.area + log.total.seeds + (1|plot), data = clip, family = "binomial")
sur.17 <- glmer(psurvivalT1 ~ log.ros.area*log.total.seeds + (1|plot), data = clip, family = "binomial")
sur.18 <- glmer(psurvivalT1 ~ log.ros.area + log.cap + (1|plot), data = clip, family = "binomial")
sur.19 <- glmer(psurvivalT1 ~ log.ros.area*log.cap +(1|plot), data = clip, family = "binomial")


survival <- mget(ls(pattern = "sur.")) #make a list of all of those models that start with gm (^ means start with)
survival_AICc<-aictab(cand.set = survival, modnames = model.names,second.ord=TRUE,nobs=NULL,sort=TRUE)
surv.AIC <- as.data.frame(survival_AICc)
#write.csv(x = surv.AIC, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/tables/clipping experiment/survival AIC table.csv")
#rm(list = ls()[grepl("sur", ls())]) #removes these models
#the "best" 2 models give weird warnigns so going with the null model with just size
```

```{r survival best fit }
#create df with all possible x values
#this is for model without an interaction
pred.dat <-  expand.grid(log.ros.area = seq(2, 5.5, by = .1))
pred.output <- predict(sur.01, newdata = pred.dat, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.output <- as.data.frame(pred.output)
pred.dat.output <- cbind(pred.dat, pred.output) %>% 
  rename(survT1 = pred.output)

survival <- ggplot(clip, aes(x = log.ros.area, y = psurvivalT1))+
  geom_point()+
  geom_line(data = pred.dat.output, aes(x = log.ros.area, y = survT1))+
  scale_x_continuous(expand = c(0, 0), limits = c(0, 6))+
  labs(x = "log(Rosette Area) in 2021", y = "Survival in 2022")
survival
#ggsave(plot = survival, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/survival.png", width = 6, height = 6, dpi = 300)

```



#############################################################################################










```{r include = F, eval = FALSE}
################################################################################
# Plan B! 

# calculate relative growth rate - did plants that were clipped grow more or less than plants that weren't
clip %>% ggplot(aes(trt, rgr))+
  geom_boxplot()#+
  facet_wrap(~treatment)

m1 <- lmer(rgr~trt+ (1|plot), data = clip, REML = F)
anova(m1)
summary(m1)
#drought plants grew more than control plants! and irrigated grew less than control plants? hmm that seems weird. But no effect of clipping treatment on growth 
#
# to make sure these are the same size: only include plants that were above ground in 2022
# 
fnull <- glmer(pflowerT1 ~ 1 + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
f1 <- glmer(pflowerT1 ~ rgr + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(fnull, f1, test="Chisq") #LTR test
#nope!

f2<- glmer(pflowerT1 ~ fruitset + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(fnull, f2, test="Chisq") #LTR test
#yep!

f3<- glmer(pflowerT1 ~ fruitset + rgr + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(f2, f3, test="Chisq") #LTR test
#nope adding rgr doesnt help

f4<- glmer(pflowerT1 ~ fruitset*rgr + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial")
anova(f2, f4, test="Chisq") #LTR test
#nope

f5<- glmer(pflowerT1 ~ trt + (1|plot), data = subset(clip.sub, !is.na(rgr)), family = "binomial") #singular fit!
anova(fnull, f5, test="Chisq") #LTR test



```

```{r include = F, eval = FALSE}
#not using size in model - this may be weird..
#GROWTH

ggplot(clip.sub, aes(x = trt, y = log.ros.areaT1))+
  geom_boxplot()
ggplot(clip.sub, aes(x = plot, y = log.ros.areaT1, color = trt))+
  geom_boxplot()
ggplot(clip.sub, aes(x = treatment, y = log.ros.areaT1))+
  geom_boxplot()+
  facet_wrap(~trt)

#with random effects
gnull<- lmer(log.ros.areaT1 ~ trt +(1|plot), data = clip.sub, REML = F)
gnull1<- lmer(log.ros.areaT1 ~ treatment + (1|plot), data = clip.sub, REML= F)
gnull2<- lmer(log.ros.areaT1 ~ treatment + trt + (1|plot), data = clip.sub, REML= F)
anova(gnull, gnull2, test="Chisq") #this is LRT?
summary(gnull2)

```

```{r include = F, eval = FALSE}

#with random effects
gnull<- lmer(log.ros.areaT1 ~ trt +(1|plot), data = clip.sub, REML = F)
gnull1<- lmer(log.ros.areaT1 ~  fruitset*trt + (1|plot), data = clip.sub, REML= F)
anova(gnull, gnull1, test="Chisq") #this is LRT?
summary(gnull1)

fnull<- lmer(pflowerT1 ~ (1|plot), data = clip.sub, REML = F)
fnull1<- lmer(pflowerT1 ~ fruitset + (1|plot), data = clip.sub, REML= F)
fnull2<- lmer(pflowerT1 ~ treatment + trt + (1|plot), data = clip.sub, REML= F)
anova(fnull, fnull1, test="Chisq") #this is LRT?
summary(gnull2)
```


Maybe cost is in whether or not you flower, not how much effort you put into flowering?

Growth::
```{r growth,  include = F, eval = FALSE}
#######################################################################################

join <- join %>% 
  mutate(plot = as.factor(plot),
         trt = as.factor(trt),
         treatment = as.factor(treatment))

###
ggplot(clip, aes(x = log.ros.area, y = log.ros.areaT1))+
  geom_jitter()+
  geom_smooth(method = "lm", se = F)+
  geom_abline(slope=1, intercept=0)+
  facet_wrap(~treatment)
ggplot(join, aes(x = log.ros.area, y = log.ros.areaT1))+
  geom_jitter()+
  geom_smooth(method = "lm", se = F)+
  geom_abline(slope=1, intercept=0)+
  facet_wrap(trt~treatment)

#gnull.base <- lmer(log.ros.areaT1 ~ 1 + (1|plot), data = join, REML = F)
gnull<- lmer(log.ros.areaT1 ~ log.ros.area + (1|plot), data = join, REML = F)
#growth <- anova(gnull.base, gnull, test="Chisq") #this is LRT

#including size improves the model:

gnull1<- lmer(log.ros.areaT1 ~ log.ros.area + treatment + (1|plot), data = join, REML = F)
summary(gnull1)
growth <- anova(gnull, gnull1, test="Chisq") #this is LRT
growth #no cost on growth with just clipping treatment


gnull2<- lmer(log.ros.areaT1 ~ log.ros.area + trt + (1|plot), data = join, REML = F)
anova(gnull, gnull2, test="Chisq") #this is LRT
#nope!
growth_stat <- rbind(growth,growth1)
gnull2<- lmer(log.ros.areaT1 ~ log.ros.area+treatment*trt + (1|plot), data = join, REML= F)
anova(gnull, gnull2, test="Chisq") #this is LRT?
summary(gnull)

###
#how to get fruitset in here - cant use the vegetative plants here because they have fruitset  = NA
#run other models?
gnull.base <- lmer(log.ros.areaT1 ~ 1 + (1|plot), data = subset(join, !is.na(fruitset)), REML = F)
gnull<- lmer(log.ros.areaT1 ~ log.ros.area + (1|plot), data = subset(join, !is.na(fruitset)), REML = F)
anova(gnull.base, gnull, test="Chisq") #this is LRT


gnull1<- lmer(log.ros.areaT1 ~ log.ros.area + fruitset + (1|plot), data = subset(join, !is.na(fruitset)), REML = F)
anova(gnull, gnull1, test="Chisq") #this is LRT

gnull2<- lmer(log.ros.areaT1 ~ log.ros.area*fruitset + (1|plot), data = subset(join, !is.na(fruitset)), REML = F)
anova(gnull, gnull2, test="Chisq") #this is LRT


#no, doing it with fruitset doesnt help
#no cost on growth

###
# step package:
# https://search.r-project.org/CRAN/refmans/lmerTest/html/step.lmerModLmerTest.html
# backwards selection:
growth.full<- lmerTest::lmer(log.ros.areaT1 ~ log.ros.area*log.total.seeds*trt + (1|plot), data = subset(!(is.na(clip$log.total.seeds))), REML= F)


step_fm <- lmerTest::step(growth.full,reduce.random=FALSE)
step_fm # Display elimination results
final_fm <- get_model(step_fm)

```

```{r  include = F, eval = FALSE}

#pflower:
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .05)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~treatment)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .05)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~trt)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .05)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(treatment~trt,  ncol = 3)+
  labs(x = "Log(rosette area) in 2021", y = "Probability of flowering in 2022")

fnull <- glmer(pflowerT1 ~ log.ros.area + (1|plot), data = join, family = "binomial")
f1 <- glmer(pflowerT1 ~ log.ros.area + trt + (1|plot), data = join, family = "binomial")
anova(fnull, f1, test="Chisq") #LTR test
#nope

f2<- glmer(pflowerT1 ~ log.ros.area+treatment + (1|plot), data = join, family = "binomial")
anova(fnull, f2, test="Chisq") #LTR test
#yes, significant! But seems like it is mostly for veg vs the rest

f3<- glmer(pflowerT1 ~ log.ros.area + treatment*trt + (1|plot), data = join, family = "binomial")
anova(f2, f3, test="Chisq") #LTR test

summary(f2)

#what about adding fruitset? NOPE!
fnull <- glmer(pflowerT1 ~ log.ros.area + (1|plot), data = subset(join, !is.na(fruitset)), family = "binomial")
f1 <- glmer(pflowerT1 ~ log.ros.area + fruitset + (1|plot), data = subset(join, !is.na(fruitset)), family = "binomial")
anova(fnull, f1, test="Chisq")


```

```{r include = F, eval = FALSE}
#Survival
#pflower:
ggplot(subset(join, !is.na(psurvivalT1)), aes(x = log.ros.area, y = as.factor(psurvivalT1)))+
  geom_jitter(height = .05)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~treatment)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .01)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~trt)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_jitter(height = .01)+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(treatment~trt,  ncol = 3)+
  labs(x = "Log(rosette area) in 2021", y = "Probability of flowering in 2022")

s<- glmer(as.factor(psurvivalT1) ~ 1 + (1|plot), data = join, family = "binomial")
snull <- glmer(as.factor(psurvivalT1) ~ log.ros.area + (1|plot), data = join, family = "binomial")
anova(s, snull,test="Chisq") #LTR test

snull1 <- glmer(as.factor(psurvivalT1) ~  treatment + (1|plot), data = join, family = "binomial")
anova(s, snull1,test="Chisq") #LTR test

snull2 <- glmer(as.factor(psurvivalT1) ~  trt + (1|plot), data = join, family = "binomial")
anova(s, snull2,test="Chisq") #LTR test

snull3 <- glmer(as.factor(psurvivalT1) ~  trt+treatment + (1|plot), data = join, family = "binomial")
anova(s, snull3,test="Chisq") #LTR test

#doesnt converge
#snull4 <- glmer(as.factor(psurvivalT1) ~  trt*treatment + (1|plot), data = join, family = "binomial")
#anova(s, snull4,test="Chisq") #LTR test
```

#What to do about differential flowering success → what about 3 models

```{r include = F, eval = FALSE}
#Probability of flowering model…
fbase <- glmer(as.factor(pflowerT1) ~ 1 + (1|plot), data = join, family = "binomial")
fnull <- glmer(as.factor(pflowerT1) ~ log.ros.area + (1|plot), data = join, family = "binomial")
anova(fbase, fnull, test="Chisq") #LTR test

f1 <- glmer(as.factor(pflowerT1) ~ log.ros.area + treatment + (1|plot), data = join, family = "binomial")
anova(fnull, f1, test="Chisq") #LTR test

f1.1 <- glmer(as.factor(pflowerT1) ~ log.ros.area*treatment + (1|plot), data = join, family = "binomial")
anova(f1, f1.1, test="Chisq") #LTR test

#singular fit
#f2 <- glmer(as.factor(pflowerT1) ~ log.ros.area + trt + (1|plot), data = join, family = "binomial")
#anova(fnull, f2, test="Chisq") #LTR test
#great, this one is sig

f3 <- glmer(as.factor(pflowerT1) ~ log.ros.area*trt + (1|plot), data = join, family = "binomial")
anova(fnull, f3, test="Chisq") #LTR test

f4 <- glmer(as.factor(pflowerT1) ~ log.ros.area+trt+treatment + (1|plot), data = join, family = "binomial")
anova(f1, f4, test="Chisq") #LTR test
f5 <- glmer(as.factor(pflowerT1) ~ log.ros.area+trt*treatment + (1|plot), data = join, family = "binomial")
anova(f1, f5, test="Chisq") #LTR test

summary(f5)

```
```{r  include = F, eval = FALSE}
## make graph for that model:
# pflower av plots
pred.control<-  expand.grid(log.ros.area = seq(1, 5.25, by = .1), trt = "control")#this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip, and control plots! seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.control2 <- predict(f2, newdata = pred.control, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
control.pflower <- as.data.frame(pred.control2)
pred.control <- cbind(pred.control, control.pflower)
#
pred.irrigated<-  expand.grid(log.ros.area = seq(1, 5.25, by = .1), trt = "irrigated")#this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip, and irrigated plots! seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.irrigated2 <- predict(f2, newdata = pred.irrigated, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
irrigated.pflower <- as.data.frame(pred.irrigated2)
pred.irrigated <- cbind(pred.irrigated, irrigated.pflower)
#
pred.drought<-  expand.grid(log.ros.area = seq(1, 5.25, by = .1), trt = "drought")#this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip, and drought plots! seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.drought2 <- predict(f2, newdata = pred.drought, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
drought.pflower <- as.data.frame(pred.drought2)
pred.drought <- cbind(pred.drought, drought.pflower)

ggplot(join, aes(x=log.ros.area, y=pflowerT1))+
  geom_jitter(height = 0.025, size = 1, alpha= 0.5) +
  geom_line(data = pred.drought, aes(x = log.ros.area, y = pred.drought2), color = Z[5], linewidth = 1) +
  geom_line(data = pred.irrigated, aes(x = log.ros.area, y = pred.irrigated2), color = Z[1], linewidth = 1) + 
  geom_line(data = pred.control, aes(x = log.ros.area, y = pred.control2), color = Z[3], linewidth = 1) + 
  labs(x = "log(Rosette Area) in 2021", y ="Probability of Flowering in 2022") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 6))

summary(f2)


```


# fecundity - 

```{r  include = F, eval = FALSE}
flbase<- glmer(no.flowersT1 ~ 1 + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
flnull <- glmer(no.flowersT1 ~ log.ros.area + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
anova(flbase, flnull ,test="Chisq") #LTR test

fl1 <- glmer(no.flowersT1 ~ log.ros.area + treatment + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
#nope, no converge

fl2 <- glmer(no.flowersT1 ~ log.ros.area + trt + (1|plot), data = subset(join, pflowerT1 == "1"), family = "poisson")
#nope singular fit!

summary(flnull)

flbase<- glm(no.flowersT1 ~ 1, data = subset(join, pflowerT1 == "1"), family = "poisson")
flnull <- glm(no.flowersT1 ~ log.ros.area, data = subset(join, pflowerT1 == "1"), family = "poisson")
anova(flbase, flnull ,test="Chisq") #LTR test

fl1 <- glm(no.flowersT1 ~ log.ros.area + treatment, data = subset(join, pflowerT1 == "1"), family = "poisson")
anova(flnull, fl1 ,test="Chisq")

fl2 <- glm(no.flowersT1 ~ log.ros.area + trt, data = subset(join, pflowerT1 == "1"), family = "poisson")
anova(flnull, fl2 ,test="Chisq")
anova(fl2)

##fruitset:
flbase<- glm(no.flowersT1 ~ 1, data = subset(join, !is.na(fruitset)), family = "poisson")
flnull <- glm(no.flowersT1 ~ log.ros.area, data = subset(join, !is.na(fruitset)), family = "poisson")
anova(flbase, flnull ,test="Chisq") #LTR test

fl1 <- glm(no.flowersT1 ~ log.ros.area+fruitset, data = subset(join, !is.na(fruitset)), family = "poisson")
anova(flnull, fl1 ,test="Chisq")

```


```{r include = FALSE, eval = FALSE}


#pflower:
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_point()+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~plot)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_point(aes(size = fruitset))+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~trt)
ggplot(join, aes(x = log.ros.area, y = pflowerT1))+
  geom_point(aes(size = fruitset, color = trt))+
  geom_smooth(method = "glm", method.args = list(family = binomial), se = F)+
  facet_wrap(~treatment)
```

#Probability of successfully making seeds ~ treatment*size (data = plants that tried to flower)
```{r  include = F, eval = FALSE}
#of plants that tried to flower, what was their probability of making seeds:
seed <- glmer(as.factor(pseeds) ~ 1 + (1|plot), data = join, family = "binomial")
seed2 <- glmer(as.factor(pseeds) ~ log.ros.area + (1|plot), data = join, family = "binomial")
anova(seed, seed2, test="Chisq") #LTR test
#yes, bigger plants make more seeds

seed3 <- glmer(as.factor(pseeds) ~ log.ros.area + trt + (1|plot), data = join, family = "binomial")
#did not converge
```


#Seed production ~ treatment*size (data = plants that made seeds, this is Poisson)
```{r seed production}
#of plants that made seeds, did that differ between treatment?
noseeds<- glmer(total.seeds ~ 1 + (1|plot), data = subset(clip, pseeds ==1), family = "poisson")
noseeds1 <- glmer(as.numeric(total.seeds) ~ log.ros.area + (1|plot), data = subset(clip, pseeds == 1), family = "poisson")
anova(noseeds, noseeds1 ,test="Chisq") #LTR test
#yep its better

noseeds2 <- glmer(total.seeds ~ log.ros.area + trt + (1|plot), data = subset(clip, pseeds == 1), family = "poisson")
anova(noseeds1, noseeds2 ,test="Chisq") #LTR test
#yep

noseeds3 <- glmer(total.seeds ~ log.ros.area*trt + (1|plot), data = subset(clip, pseeds == 1), family = "poisson")
anova(noseeds2, noseeds3 ,test="Chisq") #LTR test
#yep!
summary(noseeds2)

summary(noseeds3)
#...it doesnt make sense to add clipping treatment, right? 

noseeds4 <- glmer(total.seeds ~ log.ros.area + treatment + (1|plot), data = subset(clip, pseeds == 1), family = "poisson")
anova(noseeds1, noseeds4 ,test="Chisq") #LTR test
summary(noseeds4)

noseeds5 <- glmer(total.seeds ~ log.ros.area + trt+treatment + (1|plot), data = subset(clip, pseeds == 1), family = "poisson")
anova(noseeds2, noseeds5 ,test="Chisq") #LTR test

noseeds6 <- glmer(total.seeds ~ log.ros.area + trt*treatment + (1|plot), data = subset(clip, pseeds == 1), family = "poisson")
anova(noseeds2, noseeds6 ,test="Chisq") #LTR test

```
Great, it's significant - now make a graph

```{r include = F, eval = FALSE}
ggplot(subset(clip, pseeds == 1), aes(log.ros.area, log.total.seeds))+
  geom_point()+
  geom_smooth(method="glm", method.args=list(family="poisson"), se = F)+
  facet_wrap(trt~treatment)+
  labs()
```

```{r include = F, eval = FALSE}
#noseeds3
pred.dat.control <-  expand.grid(log.ros.area = seq(3.25, 5.25, by = .1), trt = "control") #this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.control <- predict(noseeds3, newdata = pred.dat.control, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.control <- as.data.frame(pred.control)
pred.control <- cbind(pred.dat.control, pred.control)

pred.dat.irrigated <-  expand.grid(log.ros.area = seq(3.25, 5.25, by = .1), trt = "irrigated") #this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.irrigated <- predict(noseeds3, newdata = pred.dat.irrigated, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.irrigated <- as.data.frame(pred.irrigated)
pred.irrigated <- cbind(pred.dat.irrigated, pred.irrigated)

pred.dat.drought <-  expand.grid(log.ros.area = seq(3.25, 5.25, by = .1), trt = "drought") #this is making a set of data that the model will predict points for. size 0:6, 25th quarile of summer precip seq(0, 6, by = .1) is the same as 0:6 but smaller increments
pred.drought <- predict(noseeds3, newdata = pred.dat.drought, type="response", re.form=~0) #re.form = ~0 tells it to not include random effects
pred.drought <- as.data.frame(pred.drought)
pred.drought <- cbind(pred.dat.drought, pred.drought)

no.seeds <- ggplot(subset(clip, pseeds == 1), aes(x=log.ros.area, y=total.seeds))+
  geom_jitter(height = 0.025, size = 2, alpha= 0.5) +
  geom_line(data = pred.drought, aes(x = log.ros.area, y = pred.drought), color = Z[5], linewidth = 1) +
  geom_line(data = pred.irrigated, aes(x = log.ros.area, y = pred.irrigated), color = Z[1], linewidth = 1) + 
  geom_line(data = pred.control, aes(x = log.ros.area, y = pred.control), color = Z[3], linewidth = 1) + 
  labs(x = "log(Rosette Area) in 2021", y = "Total seeds in 2021") +
  theme(axis.line = element_line(colour = 'black', linewidth = 1.1), text = element_text(size = 15))#+
    #scale_x_continuous(expand = c(0, 0), limits = c(0, 6))

no.seeds
#ggsave(plot = no.seeds, file = "C:/Users/Jenna/OneDrive - The University Of British Columbia/Data Projects/Primula/Figures/clipping experiment/round 2/poisson.seedproduction.png", width = 6, height = 6, dpi = 300)


```


